print("Rider Trial Auto + Mirror Box") -- LocalScript (StarterPlayerScripts)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local WORKSPACE = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

-- ====== Remote ======
local RiderTrialRemote = ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Event"):WaitForChild("RiderTrial")
local DimensionWorldRemote = ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Specific"):WaitForChild("DimensionWorldRemote")

local player = Players.LocalPlayer

-- ====== Boss Config (TRIAL) ======
local LIVES_FOLDER_NAME = "Lives"
local BOSS_NAME = "Hunter Lv.70"

local function getLivesFolder()
	return WORKSPACE:FindFirstChild(LIVES_FOLDER_NAME)
end

local function isBossPresent()
	local lives = getLivesFolder()
	return lives and lives:FindFirstChild(BOSS_NAME) ~= nil
end

local function getBossModel()
	local lives = getLivesFolder()
	if not lives then return nil end
	return lives:FindFirstChild(BOSS_NAME)
end

-- ====== MIRROR BOX CONFIG ======
local MIRROR_FOLDER_NAME = "Lives"
local MIRROR_NAME = "Bat User Lv.12" -- SESUAIKAN dengan nama di Workspace

local function getMirrorFolder()
	return WORKSPACE:FindFirstChild(MIRROR_FOLDER_NAME)
end

local function isMirrorPresent()
	local lives = getMirrorFolder()
	return lives and lives:FindFirstChild(MIRROR_NAME) ~= nil
end

local function getMirrorModel()
	local lives = getMirrorFolder()
	if not lives then return nil end
	return lives:FindFirstChild(MIRROR_NAME)
end

-- ====== AUTO EQUIP ATTACK TOOL ======
local TOOL_NAME = "Attack"

local function equipAttackTool()
	local character = player.Character or player.CharacterAdded:Wait()
	local humanoid = character:WaitForChild("Humanoid")
	local backpack = player:WaitForChild("Backpack")

	local tool = backpack:FindFirstChild(TOOL_NAME)
	if tool and tool:IsA("Tool") then
		humanoid:EquipTool(tool)
	end
end

if player.Character then
	equipAttackTool()
end

player.CharacterAdded:Connect(function()
	task.wait(0.5)
	equipAttackTool()
end)

-- ====== GET HANDLER EVENT (COMMON) ======
local function getHandlerEvent()
	local character = player.Character
	if not character or not character.Parent then return nil end

	local ok, result = pcall(function()
		local handler = character:WaitForChild("PlayerHandler", 3)
		if not handler then return nil end
		return handler:WaitForChild("HandlerEvent", 3)
	end)

	return ok and result or nil
end

-- ====== AUTO HENSHIN ======
local function autoHenshin()
	local handlerEvent = getHandlerEvent()
	if not handlerEvent then return false end

	local success = pcall(function()
		local args = { { Henshin = true } }
		handlerEvent:FireServer(unpack(args))
	end)

	if success then
		StarterGui:SetCore("SendNotification", {Title = "Henshin", Text = "EXECUTED!", Duration = 2})
		return true
	end
	return false
end

-- ====== AUTO SHARK (7s) UNTUK TRIAL ======
local function executeAutoShark()
	task.wait(7)
	DimensionWorldRemote:InvokeServer({"GUI"})
	task.wait(0.5)
	DimensionWorldRemote:InvokeServer({"WeaponSelected", "Shark", "Shark Vent"})
	task.wait(0.5)
	DimensionWorldRemote:InvokeServer({"Transform", "Shark"})
	StarterGui:SetCore("SendNotification", {Title = "Shark", Text = "COMPLETE!", Duration = 2})

	task.delay(2, function()
		equipAttackTool()
		StarterGui:SetCore("SendNotification", {Title = "Attack", Text = "EQUIPPED!", Duration = 2})
	end)
end

-- ====== AUTO SHARK 0s (UNTUK MIRROR BUTTON) ======
local function executeAutoSharkInstant()
	DimensionWorldRemote:InvokeServer({"GUI"})
	DimensionWorldRemote:InvokeServer({"WeaponSelected", "Shark", "Shark Vent"})
	DimensionWorldRemote:InvokeServer({"Transform", "Shark"})
	StarterGui:SetCore("SendNotification", {Title = "Shark", Text = "INSTANT!", Duration = 2})
end

-- ====== AUTO ATTACK (HEAVY + E + V SPAM) ======
local MOUSE_CFRAME = CFrame.new(-2678.40234375, 0.7871074, -674.6618652, 1,0,0, 0,1,0, 0,0,1)

local ATTACK_DELAY = 0.5

local function fireHeavyAttack()
	local handlerEvent = getHandlerEvent()
	if not handlerEvent then return end

	local args = {
		{
			CombatAction = true,
			AttackType = "Down",
			HeavyAttack = true,
			MouseData = MOUSE_CFRAME
		}
	}
	handlerEvent:FireServer(unpack(args))
end

local function fireSkill(key)
	local handlerEvent = getHandlerEvent()
	if not handlerEvent then return end

	local args = {
		{
			Skill = true,
			AttackType = "Down",
			Key = key,
			MouseData = MOUSE_CFRAME
		}
	}
	handlerEvent:FireServer(unpack(args))
end

-- TRIAL ATTACK LOOP
local autoAttackRunning = false

local function startAutoAttack()
	if autoAttackRunning then return end
	autoAttackRunning = true

	task.spawn(function()
		while autoAttackRunning and isBossPresent() do
			fireHeavyAttack()
			fireSkill("E")
			fireSkill("V")
			task.wait(ATTACK_DELAY)
		end
		autoAttackRunning = false
	end)
end

local function stopAutoAttack()
	autoAttackRunning = false
end

-- MIRROR ATTACK LOOP
local autoMirrorAttackRunning = false

local function startMirrorAttack()
	if autoMirrorAttackRunning then return end
	autoMirrorAttackRunning = true

	task.spawn(function()
		while autoMirrorAttackRunning and isMirrorPresent() do
			fireHeavyAttack()
			fireSkill("E")
			fireSkill("V")
			task.wait(ATTACK_DELAY)
		end
		autoMirrorAttackRunning = false
	end)
end

local function stopMirrorAttack()
	autoMirrorAttackRunning = false
end

-- ====== AUTO APPROACH TRIAL (~7 studs) ======
local autoApproachRunning = false

local function startAutoApproach()
	if autoApproachRunning then return end
	autoApproachRunning = true

	task.spawn(function()
		while autoApproachRunning and isBossPresent() do
			local boss = getBossModel()
			local character = player.Character
			if boss and character and character:FindFirstChild("HumanoidRootPart") then
				local hrp = character.HumanoidRootPart
				local bossRoot = boss:FindFirstChild("HumanoidRootPart") or boss:FindFirstChild("Torso") or boss.PrimaryPart

				if bossRoot then
					local bossPos = bossRoot.Position
					local playerPos = hrp.Position
					local dir = (bossPos - playerPos)

					if dir.Magnitude > 0 then
						local targetPos
						if dir.Magnitude > 7 then
							local unit = dir.Unit
							targetPos = bossPos - unit * 7
						else
							targetPos = playerPos
						end

						local tweenInfo = TweenInfo.new(0.35, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
						local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos, bossPos)})
						tween:Play()
					end
				end
			end

			task.wait(0.4)
		end

		autoApproachRunning = false
	end)
end

local function stopAutoApproach()
	autoApproachRunning = false
end

-- ====== AUTO APPROACH MIRROR (Bat User saja) ======
local autoMirrorApproachRunning = false

local function startMirrorApproach()
	if autoMirrorApproachRunning then return end
	autoMirrorApproachRunning = true

	task.spawn(function()
		while autoMirrorApproachRunning and isMirrorPresent() do
			local target = getMirrorModel()
			local character = player.Character
			if target and character and character:FindFirstChild("HumanoidRootPart") then
				local hrp = character.HumanoidRootPart
				local targetRoot = target:FindFirstChild("HumanoidRootPart") or target:FindFirstChild("Torso") or target.PrimaryPart

				if targetRoot then
					local bossPos = targetRoot.Position
					local playerPos = hrp.Position
					local dir = (bossPos - playerPos)

					if dir.Magnitude > 0 then
						local targetPos
						if dir.Magnitude > 7 then
							local unit = dir.Unit
							targetPos = bossPos - unit * 7
						else
							targetPos = playerPos
						end

						local tweenInfo = TweenInfo.new(0.35, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
						local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos, bossPos)})
						tween:Play()
					end
				end
			end

			task.wait(0.4)
		end

		autoMirrorApproachRunning = false
	end)
end

local function stopMirrorApproach()
	autoMirrorApproachRunning = false
end

-- ====== SEQUENCES (TRIAL FLOW) ======
local function startTrial()
	RiderTrialRemote:FireServer("Trial of Diend")
end

local function initialSequence()
	task.wait(2)
	autoHens
