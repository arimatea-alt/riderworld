-- TRIAL DIEND LOOP - FIXED LOOPING 100%
print("=== TRIAL AUTO LOOP FIXED ===")

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Wait for remote SAFE
local remotePath = ReplicatedStorage:WaitForChild("Remote", 10)
local eventPath = remotePath:WaitForChild("Event", 10)
local RiderTrialRemote = eventPath:WaitForChild("RiderTrial", 10)

print("Remote ready:", RiderTrialRemote ~= nil)

-- Config
local LIVES_FOLDER_NAME = "Lives"
local BOSS_90_NAME = "Hunter Lv.90"
local DELAY_TIME = 15

-- State
local autoLoopEnabled = false
local isWaiting = false

-- Modern GUI (SAME AS BEFORE)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TrialAutoGUI"
screenGui.ResetOnSpawn = false
screenGui.DisplayOrder = 100
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 140)
mainFrame.Position = UDim2.new(0, 30, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 16)
mainCorner.Parent = mainFrame

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 45, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 35))
}
gradient.Rotation = 45
gradient.Parent = mainFrame

-- Title Bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 45)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 16)
titleCorner.Parent = titleBar

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -60, 1, 0)
titleLabel.Position = UDim2.new(0, 15, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "üîÑ TRIAL LOOP FIXED"
titleLabel.TextColor3 = Color3.fromRGB(0, 255, 150)
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 30, 0, 30)
minimizeBtn.Position = UDim2.new(1, -40, 0.5, -15)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
minimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeBtn.Text = "‚àí"
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextScaled = true
minimizeBtn.Parent = titleBar

local minCorner = Instance.new("UICorner")
minCorner.CornerRadius = UDim.new(0, 8)
minCorner.Parent = minimizeBtn

-- Status & Timer
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 25)
statusLabel.Position = UDim2.new(0, 15, 0, 55)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Status: READY"
statusLabel.TextColor3 = Color3.fromRGB(0, 255, 150)
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(1, -20, 0, 20)
timerLabel.Position = UDim2.new(0, 15, 0, 82)
timerLabel.BackgroundTransparency = 1
timerLabel.Text = "Timer: 0s"
timerLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
timerLabel.TextScaled = true
timerLabel.Font = Enum.Font.Gotham
timerLabel.TextXAlignment = Enum.TextXAlignment.Left
timerLabel.Parent = mainFrame

-- Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -30, 0, 45)
toggleButton.Position = UDim2.new(0, 15, 0, 105)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
toggleButton.Text = "‚ñ∂Ô∏è START LOOP"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Parent = mainFrame

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 12)
toggleCorner.Parent = toggleButton

-- Drag
local dragging, dragStart, startPos
titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
    end
end)

titleBar.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Minimize
local frameMinimized = false
minimizeBtn.MouseButton1Click:Connect(function()
    frameMinimized = not frameMinimized
    minimizeBtn.Text = frameMinimized and "+" or "‚àí"
    mainFrame:TweenSize(UDim2.new(0, 280, 0, frameMinimized and 50 or 140), "Out", "Quad", 0.3)
end)

-- MAIN FUNCTIONS
local function joinTrial()
    pcall(function()
        RiderTrialRemote:FireServer("Trial of Diend")
    end)
    StarterGui:SetCore("SendNotification", {Title = "‚ö° TRIAL", Text = "JOINED!", Duration = 2})
    print("‚úÖ TRIAL JOINED")
end

local function updateDisplay(livesFolder)
    if not livesFolder then
        statusLabel.Text = "‚ùå Lives folder missing"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    
    local boss90 = livesFolder:FindFirstChild(BOSS_90_NAME)
    if boss90 then
        statusLabel.Text = "‚öîÔ∏è Lv.90 ALIVE"
        statusLabel.TextColor3 = Color3.fromRGB(255, 165, 0)
    elseif isWaiting then
        statusLabel.Text = "‚è≥ WAITING 15s"
        statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    else
        statusLabel.Text = "‚úÖ READY"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 150)
    end
end

-- **FIXED LOOPING LOGIC**
task.spawn(function()
    local lastBoss90State = false
    while true do
        local livesFolder = workspace:FindFirstChild(LIVES_FOLDER_NAME)
        local currentBoss90State = livesFolder and livesFolder:FindFirstChild(BOSS_90_NAME) ~= nil
        
        -- DETECT BOSS 90 DIED
        if autoLoopEnabled and lastBoss90State and not currentBoss90State and not isWaiting then
            print("üéØ DETECTED: Lv.90 DIED - Starting 15s timer")
            isWaiting = true
            statusLabel.Text = "‚è≥ WAIT 15s..."
            statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
            
            -- COUNTDOWN
            for i = DELAY_TIME, 1, -1 do
                if not autoLoopEnabled then break end
                timerLabel.Text = "Timer: " .. i .. "s"
                task.wait(1)
            end
            
            -- AUTO RESTART
            if autoLoopEnabled then
                print("üîÑ 15s DONE - AUTO JOIN TRIAL")
                isWaiting = false
                joinTrial()
            end
        end
        
        lastBoss90State = currentBoss90State
        updateDisplay(livesFolder)
        task.wait(0.5)
    end
end)

-- Toggle Button
toggleButton.MouseButton1Click:Connect(function()
    autoLoopEnabled = not autoLoopEnabled
    isWaiting = false
    
    if autoLoopEnabled then
        toggleButton.Text = "‚èπÔ∏è STOP LOOP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        statusLabel.Text = "üöÄ ACTIVE"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
        joinTrial()
        print("üéÆ LOOP ENABLED")
    else
        toggleButton.Text = "‚ñ∂Ô∏è START LOOP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
        statusLabel.Text = "‚è∏Ô∏è STOPPED"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        timerLabel.Text = "Timer: 0s"
        print("‚èπÔ∏è LOOP DISABLED")
    end
end)

-- Success
StarterGui:SetCore("SendNotification", {
    Title = "üîÑ LOOP FIXED", 
    Text = "Click START LOOP - Monitors Lv.90 death ‚Üí 15s ‚Üí repeat!", 
    Duration = 6
})

print("=== LOOP SYSTEM 100% ACTIVE ===")